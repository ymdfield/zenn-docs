---
title: "Tagless-finalã¨è‡ªç”±ãƒ¢ãƒŠãƒ‰ã®é–¢ä¿‚"
emoji: "ğŸ“œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
    - "monad"
    - "effect"
    - "TaglessFinal"
published: false
---

æœ¬è¨˜äº‹ã¯ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®è¦³ç‚¹ã‹ã‚‰ã€Tagless-finalã¨è‡ªç”±ãƒ¢ãƒŠãƒ‰ã®ç­‰ä¾¡æ€§ã¨å¾®å¦™ãªé•ã„ã«ã¤ã„ã¦ç¤ºã™ã‚‚ã®ã§ã™ã€‚
ãªãŠã‚³ãƒ¼ãƒ‰ã«ã¯Haskellã‚’ä½¿ç”¨ã—ã¾ã™`forall`ã¯ä»£ã‚ã‚Šã«`âˆ€`ã¨è¡¨è¨˜ã—ã¾ã™ã€‚èª­è€…ã¯é©å®œScalaãªã©ã®ä»–è¨€èªã«èª­ã¿æ›¿ãˆã¦ãã ã•ã„ï¼ˆLLMã‚’ä½¿ç”¨ã™ã‚‹ã¨ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰ã€‚
ã“ã“ã§ã¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¯ä¸€éšã®ã‚‚ã®ã«é™ã‚Šã€ã¾ãŸTagless-finalã‚’è¡¨ç¾ã™ã‚‹å‹ã‚¯ãƒ©ã‚¹ã®è¦ªã‚¯ãƒ©ã‚¹ã¯Monadã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã™ï¼ˆMonadicãªã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰ã€‚

Tagless-finalã§ã¯ã€ä¾‹ãˆã°æ¨™æº–å…¥å‡ºåŠ›ã‚’æ‰±ã†ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ`Console`ã‚’ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‹ã‚¯ãƒ©ã‚¹ã§è¡¨ç¾ã—ã¾ã™ã€‚

```hs
class Monad m => Console m where
    writeStdout :: String -> m ()
    writeStderr :: String -> m ()
    readLineStdin :: m String
```

ãã—ã¦ã€`Console`ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å«ã‚€ã‚ˆã†ãªã‚¨ãƒ•ã‚§ã‚¯ãƒˆä»˜ããƒ—ãƒ­ã‚°ãƒ©ãƒ `prog`ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå‹ãŒä»˜ãã¾ã™ã€‚

```hs
prog : âˆ€m. Console m => m A
```

ä¸€æ–¹ã€è‡ªç”±ãƒ¢ãƒŠãƒ‰ (`Freer`) ã®æ–¹æ³•ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªGADTã«ã‚ˆã‚Šã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¾ã—ã¾ã™ã€‚

```hs
data Console' a where
    WriteStdout :: String -> Console' ()
    WriteStderr :: String -> Console' ()
    ReadLineStdin :: Console' String
```

ãã—ã¦ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä»˜ããƒ—ãƒ­ã‚°ãƒ©ãƒ `prog'`ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå‹ãŒä»˜ãã¾ã™ã€‚

```hs
prog' :: Freer Console' A
```

ä¸€èˆ¬ã«ã€Tagless-finalã§è¡¨ç¾ã•ã‚ŒãŸå‹ã‚¯ãƒ©ã‚¹ `C` ã¨ã€è‡ªç”±ãƒ¢ãƒŠãƒ‰ã®æ–¹æ³•ã§è¡¨ç¾ã•ã‚ŒãŸ GADT `D` ã¯ã€ä¾‹ã‹ã‚‰å¯Ÿã•ã‚Œã‚‹ã‚ˆã†ã«ã‚ã‚‹æ©Ÿæ¢°çš„ãªãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦ç›¸äº’ã«å¤‰æ›ãŒå¯èƒ½ã§ã™ã€‚
å‹ã‚¯ãƒ©ã‚¹ã®å„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãã‚Œãã‚ŒGADTã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨ã—ã€`m`éƒ¨åˆ†ã‚’GADTã®åå‰ã«ç½®ãæ›ãˆã‚Œã°ã‚ˆã„ã§ã™ã€‚é€†ã‚‚åŒæ§˜ã§ã™ã€‚
ã“ã®ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãç›¸äº’ã«å¤‰æ›ã—ãŸã¨ãã€Tagless-finalã«ãŠã‘ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä»˜ããƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å‹`âˆ€m. C m => m A`ã¨`Freer D A`ã¯åŒå‹ã¨ãªã‚Šã¾ã™ã€‚

åŒå‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãŸã‚ã«ã€ã¾ãš`Console`ã‚’ä¾‹ã«ã—ã¾ã™ã€‚

ã¾ãšã€`m`ã‚’å«ã‚“ã§ã„ã‚‹ä»»æ„ã®å‹`T(m)`ã«ã¤ã„ã¦ã€`C m => T(m)`ã¨ã„ã†å½¢ã®å‹ã¯ã€è¾æ›¸å‹`C_dict`ã‚’ç”¨ã„ã¦`Monad m => C_dict m -> T(m)`ã¨åŒå‹ã«å¤‰å½¢ã§ãã¾ã™ã€‚
ã“ã“ã§è¾æ›¸å‹ã¨ã„ã†ã®ã¯ã€å„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãã®ã¾ã¾ãƒ¡ãƒ³ãƒã¨ã—ã¦æŒã¤ã‚ˆã†ãªãƒ¬ã‚³ãƒ¼ãƒ‰å‹ã§ã™ã€‚`Console`ã«å¯¾ã—ã¦ã¯

```hs
data Console_dict m = Console_dict
    {   writeStdout :: String -> m ()
    ,   writeStderr :: String -> m ()
    ,   readLineStdin :: m String
    }
```

ãŒ`Console`ã®è¾æ›¸å‹ã«ãªã‚Šã¾ã™ã€‚

ãã—ã¦ã€è¾æ›¸å‹ã¯å„ãƒ¡ãƒ³ãƒã®å‹ã®ç›´ç©ã¨åŒå‹ã§ã™ã€‚ã¤ã¾ã‚Šã€`(String -> m (), String -> m (), m String)`ã¨åŒå‹ã§ã™ã€‚
ã“ã‚Œã¯å®Ÿã¯ã€Tagless-finalã§ã¯ãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤ã®å‹ãŒå¿…ãšä½•ã‚‰ã‹ã®å‹Rã«ã¤ã„ã¦`m R`ã®å½¢ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã«æ³¨ç›®ã™ã‚‹ã¨ã€GADT `Console'` ã¨
`(String :+: String + ()) -> m `

Tagless-finalã®å‹ã‚¯ãƒ©ã‚¹ `C` ãŠã‚ˆã³ãã®è¾æ›¸å‹ `C_dict` ã®ä¸€èˆ¬å½¢ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:

```hs
class Monad m => C m where
    opA :: A1 -> A2 -> ... -> m R1
    opB :: B1 -> B2 -> ... -> m R1
    ...
```

```hs
data C_dict m where
    
```
